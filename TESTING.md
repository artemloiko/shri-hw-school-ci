# README по тестированию

## Как запустить тесты

Для запуска юнит тестов клиента

```bash
cd client
npm run test
```

Для запуска юнит тестов сервера

```bash
cd server
# если не делали install, то еще и npm install
# для тестирования работы с гитом используется отдельный репозиторий который нужно склонировать в папку src/__tests__/testRepo
# для этого запустите команду (находясь в папке сервер)
git clone https://github.com/artuom130/school-ci-test-repo.git src/__tests__/testRepo
# затем можно
npm run test
```

Интеграционные тесты я запускал локально с помощью Docker и WSL
node v12.16.1
npm v6.14.4
Docker version 19.03.8
docker-compose version 1.25.4

Для hermione нужен запущенный selenium standalone, я использовал докер контейнер selenium standalone с установленным chrome
Если докер у вас установлен в корне проекта лежит docker-compose для селениума с хромом. Команда для запуска:  
`docker-compose up`, можно с флагом -d чтобы запустить в фоне `docker-compose up -d`  
Иначе можно попробовать запустить selenium-standalone локально, инструкции по запуску -> https://github.com/vvo/selenium-standalone

После запуска selenium standalone, нужно также запустить локально сервер.
Для этого нужно установить все зависимости, в корне, клиенте и сервере.
И в корне проекта выполнить команду. Она сбилдит клиент и запустит сервер в режиме теста. (Он будет хранить данные в отдельном тестовом хранилище)  
`npm run prod:test`  
Еще есть команда, которая только запускат сервер в режиме теста.  
`npm run prod:t`

После запуска сервера, для запуска интеграционных тестов выполните команду  
`npm run test:e2e` или режим html-reporter gui `npm run test:gui`

## Из каких логических блоков состоит ваше приложение и какие их сценарии вы проверяете модульными тестами?

#### Юнит тесты на клиенте

Логические блоки:

- Redux.
  Его в свою очередь можно разбить на отдельные блоки по редьюсерам, в моем случае это будут логические блоки редакса

  - builds
  - buildsDetails
  - settings
    Внутри которых я буду тестировать различные сценарии этих блоков.  
     Сценариями в данном случае будут являтся проверки с использованием различных actions.
    Например:
    - Проверка thunk actions, выполнение асинхронных операция thunk actions и проверка того что в стор пришли все необходимые экшены.

#вопрос Я начал добавлять тесты для редакса и осилил только одну часть стора это settings. Уж очень много тестов выходит и огромное кол-во похожего кода. Я в интернет нашел кучу статье о том как тестировать редакс, но не нашел не одной о том стоит ли это действительно делать. Как мне кажется тестирование стора должна заменить статическая типизация TS, т.к. при изменении структуры нам прийдется менять интерфейс, а после его смены сломается соответственно все что с ним связано.  
И собственно вопрос, нужно ли тестировать редьюсери и если да, то как это делать правильно, чтобы не писать тонну похожего кода?

- Компоненты. В данном случае покрытие может быть не полное, т.к. я хочу попробовать покрыть часть компонентов для практики.
  (Было бы круто пару получить несколько комментариев по тестам для компонентов)  
  В моем случае я планирую покрыть юнит тестами компоненты из папки base. И проверять я буду:

  - правильный рендеринг (с помощью snapshots)
  - работу с событиями (в компоненте Input)

- Утилиты. Это просто проверка вспомогательных функций из папки utils.
  Сценариями в данном случае будут зависить от самой функции.  
  Например для функции bem-cn создающий бэм классы будут следующие сценарии
  - работа с дефолтными параметрами
  - добавление модификаторов работает правильно
  - добавление миксов работает правильно

#### Юнит тесты на сервере

Логические блоки для юнит тестирования:

- Сервисы. Каждый сервис будет представлять из себя отдельный блок.
  Сценариями будут является все публичные методы каждого из сервисов.  
  Во время написания тестов для gitService появился варнинг
  `A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --runInBand --detectOpenHandles to find leaks.`.  
  Он ругается на exec внутри gitService, я добавил --forceExit для принудетельного выключения этих процессов, потому что в продакшн среде такой проблемы нет, т.к. сервер постоянно запущен.

#вопрос Я так и не придумал как проверить методы cloneRepository и метод updateBranch. Я пытался для updateBranch как-то выполнять exec внутри теста, но это завелось. Как правильнее проверить что репа копируется и внутри неё ветка переключатеся?

- Модель очереди buildQueue. Сценариями будут её публичные методы и проверятся будет её внутреннее состояние.

- Функция обработки очереди.  
  Сценарии:

  - при отсуствии элементов в очереди установлен интервал проверки, который каждые N секунд проверяет наличие элементов в очереди
  - запускает билд при обнаружении элемента во время ожидания
  - отправляет в хранилище все запросы (старт, финиш)
  - обрабатывает все элементы в очереди пока она не опустеет
  - после обработки всех элементов запускает интервал ожидания новых билдов
  - в хранилище отправляются данные в правильном формате // эту проверку я оставил статической типизации

## Какие сценарии вы проверяете интеграционными тестами?

Интеграционные тесты будут проверять:

- Взаимодействие юзера с клиентом
  - Главная страница загружается
  - Без настроек показывает Get Started
  - Отображение главной страницы с историей коммитов при наличии настроек
  - Страница настроек отображаеся
  - Инпуты работают и у них есть валидация.
  - Настройки отправляются.
  - Создание нового билда. (Кнопка run build)
  - Кнопка ребилд на деталях билда.
- Тестирование node.js api c помощью jest и supertest. (Этот пункт будет опциональный, я добавлю его если будет время)  
  Сценариями будет проверка всех ручек апи.
