# SHRI

# SHRI School CI Server

### Node.js version 12.16.1

## Getting started

```bash
cd $dir && npm ci #dirs = [server, agent]
```

В корневом [README.md](../README.md) описан запуск клиент и клиент-сервера.  
Для разработки используется nodemon

```bash
npm run start # запуск сервиса
npm run dev # запуск сервиса в дев режиме
npm run dev:debug # запуск сервиса в дебаг режиме
```

Также используется eslint на уровне всего билдера для этого нужно в папке builder выполнить

```bash
npm i
npm run lint # запустить линтера для всего проекта билдера
```

Конфигурация билд-сервера. Примеры конфигурации уже созданы, нужно только подставить свой токен (API_TOKEN).  
Токен можно получить здесь -> https://hw.shri.yandex/  
Нужно будет войти через гитхаб

```js
// файл server/server-conf.json
{
    "port": 8080,
    "apiBaseUrl": "https://hw.shri.yandex/api/",
    "apiToken": "API_TOKEN"
}

// либо передать переменные окружения
PORT=8080
API_BASE_URL="https://hw.shri.yandex/api/"
API_TOKEN="API_TOKEN"
```

Конфигурация билд-агента

```js
// файл agent/agent-conf.json
{
    "port": 5050,
    "serverHost": "127.0.0.1",
    "serverPort": 8080
}

// либо передать переменные окружения
PORT=5050
SERVER_HOST="127.0.0.1"
SERVER_PORT=8080
```

## About

#вопрос Для того чтобы добиться независимости сервера и некоторые скрипты отчасти дублируются (config и logger). Как обычно в таких случаях поступают? Унифицировать их, вынести в корень и залинковать через package.json?

Дополнительно задание сделал только для агента. Потому что на винде нельзя запускать контейнеры в локальной сети и нужно копаться с настройкой сетей в docker.

## Агент

Докер построе поверх mhart/alpine-node.  
В докер контейнер artuom130/school-ci-build-agent@latest зашит Node.js v12.16.2, поэтому при отправке билдов нужно учитывать чтобы сборка работала на v12.16.2.

Я построил уже образы и запушил на docker hub.
Для запуска других на других версиях ноды можно использовать

- artuom130/school-ci-build-agent@latest // v12.6.2
- artuom130/school-ci-build-agent@10 // v10.20.1

Так же я добавил команду `build-docker-image`, с помощью которой можно собрать образ локально.  
Ниже описаны подробности запуска.

**WARNING**
При запуске билд агента локально (без докера) никакие комманды не валидируюстя и запускаются as is.  
Безопасность выполнения комманды осуществляется за счет докер контейнера в котором создан юзер с ограниченными правами.

Запуск докера.  
По умолчанию в контейнер включен конфиг agent-conf-docker.json  
В котором serverHost = host.docker.internal, serverPort=8080, это сделано для того
чтобы из контейнера можно было достучаться до localhost. [docker-for-windows](https://docs.docker.com/docker-for-windows/networking/)
Поэтому если сервер запущен на локалхосте, то лучше не передавать через env SERVER_HOST.  
SERVER_PORT и PORT для запуска можно по прежнему передавать.

Можно передать свой SERVER_PORT  
`docker run -d -e SERVER_PORT=9090 -p 5050:5050 artuom130/school-ci-build-agent`

Если передаете PORT, то нужно опубликовать его в локальную сеть с помощью.
Порт локальной сети (первый порт в параметре -p) должен быть идентичен порту
который вы задаете агенту, потому что агент передает этот порт серверу
при регистрации и сервер будет ходить именно на порт указанный в PORT.  
`docker run -d -e PORT=4040 -p 4040:4040 artuom130/school-ci-build-agent`

По умолчанию PORT агента записан 5050. Вы можете опубликовать его на локальный порт по умолчанию.  
`docker run -d -p 5050:5050 artuom130/school-ci-build-agent`

Для запуска локально собранного образа, все тоже самое, только его имя `school-ci-build-agent`
С помощью `docker logs container_id -f` можно наблюдать за логами внутри агента.

## Сервер

Начал писать тесты, но осилил покрыть только buildServer :smiley:

Метод `POST /notify-build-result` - проксирует запрос в хранилище.  
Если в текущем списке агентов нет агента с agentId вернуть 403 ошибку.  
Тело запроса

```json
{
  "agentId": "string",
  "data": {
    "buildId": "string",
    "success": "boolean",
    "duration": "number",
    "buildLog": "string"
  }
}
```

Метод `POST /notify-agent` - сохраняет данные об агенте во внутренний список агентов.  
Из `body` вытаскиваем порт и из `request` его `hostname`.

Структура данных об агенте

```json
{
  "id": "string",
  "port": "number",
  "host": "string",
  "isBuilding": "boolean",
  "currentBuild": "object"
}
```

При регистрации агента дать ему айдишник, сохранить во внутренний список и вернуть агенту этот айдишник.
При успешном билде агент отправляет свой айдишник, чтобы по нему сбросить данные о текущем билда у агента.

## Вопросы

#### Сервер должен корректно обрабатывать ситуацию, когда агент прекратил работать между сборками.

Сервер периодически проходит цикл отправки билдов в агенты.
На очередной итерации цикла, если агент на ручке POST /build
возвращает ошибку мы оповещаем об этом, удаляем его из списка агентов и ищем следующего свободного агента.

#### Сервер должен корректно обрабатывать ситуацию, когда агент прекратил работать в процессе выполнения сборки.

Проверка агентов, каждый N минут ходить на ручку GET /build - статус 200 скипаем. Если получаем ошибку, то оповещаем о ней.  
Во внутренний список билдов добавляем в начало билд текущего агента.  
Агента удаляем из списка агентов.

При перезагрузке сервера, список прошлих агентов подгружается из сохраненного файла и он сразу же проходится по нему и проверяет все ли агенты на месте.

#### Агент должен корректно обрабатывать ситуацию, когда при старте не смог соединиться с сервером.

Оповещаем об ошибке что не можем стартануть из-за того что сервер не работает.
Т.к. у нас нет отдельной ручки с помощью которой можно привязать не вижу смысла стартовать его в холостую.

Можно было попробовать через таймаут периодически запрашивать сервер,
но это может длиться бесконечно и при этом он никакой работы полезной не сделает.

#### Агент должен корректно обрабатывать ситуацию, когда при отправке результатов сборки не смог соединиться с сервером.

Оповещаем об ошибке соединения с сервером. После чего делает shutdown.  
Я думал как вариант сохранять логи билда и отправлять их после следующего запуска,
но до следующего запуска этого агента сервер может восстановить работу
и отправить этот билд другому агенту который уже сбилдит и сохранит это.

Если при отправке логов ошибка 403 (его нет в списке агентов сервера),
сбрасывает свои результаты сборки и по новому делает /notify-agent
Я пробовал сохранять и отправлять эти результаты, но это в данном случае слишком тяжело синхронизировать.  
Поэтому просто по новой регистрируем агент, а сервер уже все разрулит.
