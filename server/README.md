# SHRI School CI Server

### Node.js version 12.16.1

[Документация API](https://documenter.getpostman.com/view/10695911/SzS2yooe?version=latest)

## Getting started

```bash
cd server
npm install
```

Для разработки используется nodemon

```bash
npm run dev // запуск nodemon
npm run dev:debug // запуск nodemon в дебаг режиме
npm run start // запуск сервера в прод режиме
```

Сервер использует конфиг заданный в .env, поэтому перед стартом нужно его создать.
Создание файла .env описано в корневом [README.md](../README.md)

## About

Текущая версия АПИ:  
Может работать только с публичными репозиториями.
Для всех запросов на билд добавляет хэш в очередь buildQueue,
которую будет обрабатывать отдельный build агент.  
buildQueue используется как Singletone на весь проект.
В модуле buildQueue экспортирую экземпляр класса BuildQueue.

#вопрос
Вот только я не уверен насколько это хороший подход,
потому что в моем случае эта очередь будет работать только в рантайме
и в случае падения и перезагруки ноды все коммиты в очереди потеряются.
Как обезопасить очередь от потери коммитов?

### Working with Git

Для работы с гитом используется класс GitService. Под капотом использует метод exec.
Выбрал exec, потому что объем информации получаемой от гита в текущей ситуации довольно
небольшой и при этом через exec удобно задавать нужные команды.

### Endpoint settings

При обновлении настроек репозиторий клонируется в рабочую папку repo.
При обновлении репозитория предыдущий удаляется и в repo записывается новый репозиторий.  
Обработка ошибок по репозиторию происходит при сохранении настроек репозитория.
Во время сохранения он пытается его склонировать и затем вытащить последний коммит из указанной ветки.
Если последний коммит еще не был сбилжен и его нет в текущей очереди, он его добавит в очередь.
Если неправильная ветка или имя репозитория вернется ошибка.

Решил в домашке ждать пока склонируется репозиторий во время запроса на сохранение настроек.
В реальном проекте мне кажется можно проверять это все на этой же ручке,
только уже через API Github, чтобы ускорить этот процесс + добавить
возможность работать с приватными репозиториями.

### Endpoint builds

Ручка `/api/builds/:commitHash POST` всегда добавляет в очередь переданный коммит,
вне зависимости от того был ли он уже добавлен в очередь или собран.

### Error handling

Для создания кастомных ошибок используется класс HttpError в src/utils/customErrors.js,
был создан для наличия у кастомных ошибок определенных полей, которые могут обрабатываться на клиенте. На данный момент это поле errorCode, которое express прокидывает в ответ в случае ошибки.

### Задание со звездочкой

Добавил node-cron таску, которая использует SettingService для добавления коммита в очередь.  
Логика такая же как и при обновлении настроек, сейчас берет только последний коммит.
В случае обновления настроек cron таск:

- пересоздается, если в новых настройках указан не нулевой период
- останавливается, если указан нулевой период
