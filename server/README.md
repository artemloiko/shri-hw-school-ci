# SHRI School CI Server

### Node.js version 12.16.1

## Getting started

```bash
cd client
npm install
```

Для разработки используется nodemon

```bash
npm run start // запуск nodemon
npm run start:debug // запуск nodemon в дебаг режиме
npm run start:prod // запуск сервера через node
```

## Описание

Текущая версия АПИ:  
Может работать только с публичными репозиториями.
Для всех запросов на билд добавляет хэш в очередь buildQueue,
которую будет обрабатывать отдельный build агент.  
buildQueue используется как Singletone на весь проект.
В модуле buildQueue экспортирую экземпляр класса BuildQueue.

#вопрос
Вот только я не уверен насколько это хороший подход,
потому что в моем случае эта очередь будет работать только в рантайме
и в случае падения и перезагруки ноды все коммиты в очереди потеряются.
Как обезопасить очередь от потери коммитов?

### Работа с гитом

Для работы с гитом используется класс GitService. Под капотом использует метод exec.
Выбрал exec, потому что объем информации получаемой от гита в текущей ситуации довольно
небольшой и при этом через exec удобно задавать нужные команды.

При обновлении настроек репозиторий клонируется в рабочую папку repo.
При обновлении репозитория предыдущий удаляется и в repo записывается новый репозиторий.  
Обработка ошибок по репозиторию происходит при сохранении настроек репозитория.
Во время сохранения он пытается его склонировать и затем вытащить последний коммит из указанной ветки.
Если неправильная ветка или имя репозитория вернется ошибка.

Решил в домашке ждать пока склонируется репозиторий во время запроса на сохранение настроек.
В реальном проекте мне кажется можно проверять это все на этой же ручке,
только уже через API Github, чтобы ускорить этот процесс + добавить
возможность работать с приватными репозиториями.

Для создания кастомных ошибок используется класс HttpError в src/utils/customErrors.js,
был создан для наличия у кастомных ошибок определенных полей, которые могут обрабатываться на клиенте. На данный момент это поле errorCode, которое express прокидывает в ответ в случае ошибки.
